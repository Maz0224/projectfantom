<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MIDI to JSON Converter</title>
</head>
<body style="font-family: sans-serif; background: #0f0f1f; color: white; text-align: center; padding: 50px;">
  <h1>MIDI â†’ JSON Converter</h1>
  <input type="file" id="midiInput" accept=".mid,.midi">
  <br><br>
  <button id="convertBtn">Convert to JSON</button>
  <br><br>
  <a id="downloadLink" style="display:none;">Download JSON</a>

  <script type="module">
    import { parseMidi } from "https://cdn.jsdelivr.net/npm/midi-file@2.1.3/+esm";

    function midiNoteToFreq(note) {
      return 440.0 * Math.pow(2, (note - 69) / 12);
    }

    function getTemplateForInstrument(name) {
      const map = {
        piano: 'synth.json',
        synth: 'synth.json',
        lead: 'synth.json',
        bells: 'blipSelect.json',
        bass: 'pickupCoin.json',
        kick: 'explosion.json',
        snare: 'hitHurt.json',
        hihat: 'click.json',
        cymbal: 'mutate.json',
        clap: 'hitHurt.json',
        tom: 'hitHurt.json'
      };
      name = name.toLowerCase();
      for (const key in map) {
        if (name.includes(key)) return map[key];
      }
      return 'synth.json';
    }

    document.getElementById("convertBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("midiInput");
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select a MIDI file first!");
        return;
      }

      const arrayBuffer = await file.arrayBuffer();
      const midiData = parseMidi(new Uint8Array(arrayBuffer));

      const levelNodes = [];
      let soundId = 1;

      for (const track of midiData.tracks) {
        const instrumentName = track.find(e => e.type === 'trackName')?.text || 'synth';
        const templateFile = getTemplateForInstrument(instrumentName);
        let currentTime = 0;

        for (const event of track) {
          if (event.type === "noteOn" && event.velocity > 0) {
            currentTime += event.deltaTime;
            const freq = midiNoteToFreq(event.noteNumber);
            const yPos = currentTime;

            const soundParameters = {
              frequencyBase: freq,
              frequencyLimit: freq,
              frequencyRamp: -100,
              frequencyDeltaRamp: -100,
              pitchJumpMod: 0.1,
              dutyCycleRamp: -1,
              flangerFrequency: 0.04607,
              highPassFilterFrequency: 3000
            };

            const node = {
              levelNodeSound: {
                position: { x: 0, y: yPos, z: 0 },
                parameters: soundParameters,
                name: instrumentName,
                volume: 1,
                maxRangeFactor: 1,
                rotation: { x: 0, y: 0, z: 0, w: 1 },
                scale: { x: 1, y: 1, z: 1 }
              }
            };
            levelNodes.push(node);

            const trigger = {
              levelNodeTrigger: {
                shape: 1001,
                position: { x: 0, y: yPos, z: 0 },
                scale: { x: 1, y: 1, z: 1 },
                rotation: { x: 0, y: 0, z: 0, w: 1 },
                isShared: true,
                triggerSources: [{ triggerSourceBasic: { type: 4 } }],
                triggerTargets: [{ triggerTargetSound: { objectID: soundId, mode: 3 } }]
              }
            };
            levelNodes.push(trigger);
            soundId++;
          }
        }
      }

      const result = {
        formatVersion: 15,
        title: "sound",
        complexity: 13,
        maxCheckpointCount: 10,
        ambienceSettings: {
          skyZenithColor: { r: 0.28, g: 0.476, b: 0.73, a: 1 },
          skyHorizonColor: { r: 0.916, g: 0.9574, b: 0.9574, a: 1 },
          sunAltitude: 45,
          sunAzimuth: 315,
          sunSize: 1
        },
        levelNodes
      };

      const jsonString = JSON.stringify(result, null, 4);
      const blob = new Blob([jsonString], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const downloadLink = document.getElementById("downloadLink");
      downloadLink.href = url;
      downloadLink.download = file.name.replace(/\.(mid|midi)$/i, ".json");
      downloadLink.textContent = "Download JSON";
      downloadLink.style.display = "inline-block";
    });
  </script>
</body>
</html>
